name: 'Build and deploy Python app to Azure Web App: lc-app-live'

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # ALLE Environment-Variablen hier zentral definiert
    env:
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DJANGO_SUPERUSER_PASSWORD: ${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
      DJANGO_ENV: production
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      APP_NAME: ${{ secrets.APP_NAME }}
      DJANGO_SETTINGS_MODULE: azureproject.production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python version
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Print debug information
      run: |
        python -c "print('üöÄ Hallo Roger! Deployment startet...')"
        python -c "import os; print(f'DB_NAME check: {os.environ.get(\"DB_NAME\")==\"lc_db\"}')"
        python -c "import os; print(f'DB_USER check: {os.environ.get(\"DB_USER\")==\"lc_db_admin\"}')"
        python -c "import os; print(f'DB_HOST check: {os.environ.get(\"DB_HOST\")==\"lcsqlserver-live.database.windows.net\"}')"
        python -c "import os; print(f'APP_NAME: {os.environ.get(\"APP_NAME\")}')"

    - name: DNS Test
      run: nslookup lcsqlserver-live.database.windows.net

    - name: Install ODBC Driver for SQL Server
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt

    - name: Test pyODBC driver
      run: |
        python -c "import pyodbc; print('‚úÖ pyODBC Treiber:', pyodbc.drivers())"

    # Migrationen ZUERST (vor dem Superuser!)
    - name: Run Django migrations
      run: |
        echo "üì¶ Django Migrationen starten..."
        python manage.py migrate
      continue-on-error: true

    # --- Datenmigration ---
    #- name: Import Blog Posts
    #  run: |
    #    echo "üìù Importiere Blog Posts..."
    #    # Ruft das Management Command auf, das wir eben erstellt haben
    #    # Voraussetzung: Datei 'blogposts_backup.json' ist im Repo committed!
    #    python manage.py sync_blogposts --import --file blogposts_backup.json || true

    # DANN Superuser anlegen (jetzt OHNE doppelte env-Deklaration)
    - name: Create Django Superuser
      run: |
        python manage.py createsuperuser \
          --noinput \
          --username littlecapa \
          --email littlecapa@googlemail.com || true

    - name: Collect static files
      run: |
        echo "üìÅ Collecting static files..."
        python manage.py collectstatic --noinput

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Zip application for deployment
      run: |
        echo "üì¶ Erstelle Deployment-Package..."
        zip -r app.zip . -x "*.git*" "tests/*" "*__pycache__*" "*.pyc" ".env"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      id: deploy-to-webapp
      with:
        app-name: ${{ env.APP_NAME }}
        package: app.zip

    - name: Restart Web App (sicherheitshalber)
      run: |
        echo "üîÑ Starte App neu..."
        az webapp restart \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }}

    - name: Deployment abgeschlossen
      run: |
        echo "‚úÖ Deployment erfolgreich!"
        echo "üåê Ihre App l√§uft unter: https://${APP_NAME}.azurewebsites.net"
