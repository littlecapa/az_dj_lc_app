name: 'Build and deploy Python app to Azure Web App: lc-app-live'

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DJANGO_ENV: production
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      APP_NAME: ${{ secrets.APP_NAME }}
      DJANGO_SETTINGS_MODULE: azureproject.production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # v3 -> v4 (neuere Version)

    - name: Set up Python version
      uses: actions/setup-python@v5  # v4 -> v5 (neuere Version)
      with:
        python-version: '3.11'  # Nicht '3.11.14' - Azure nutzt intern 3.11.x

    - name: Print debug information
      run: |
        python -c "print('ğŸš€ Hallo Roger! Deployment startet...')"
        python -c "import os; print(f'DB_NAME check: {os.environ.get(\"DB_NAME\")==\"lc_db\"}')"
        python -c "import os; print(f'DB_USER check: {os.environ.get(\"DB_USER\")==\"lc_db_admin\"}')"
        python -c "import os; print(f'DB_HOST check: {os.environ.get(\"DB_HOST\")==\"lcsqlserver-live.database.windows.net\"}')"
        python -c "import os; print(f'APP_NAME: {os.environ.get(\"APP_NAME\")}')"

    - name: DNS Test
      run: nslookup lcsqlserver-live.database.windows.net  # Alter Name war falsch!

    - name: Install ODBC Driver for SQL Server
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt

    - name: Test pyODBC driver
      run: |
        python -c "import pyodbc; print('âœ… pyODBC Treiber:', pyodbc.drivers())"

    # WICHTIG: Migrations & Collectstatic NUR ausfÃ¼hren, wenn die DB erreichbar ist
    # Falls Sie lokale GitHub Firewall-Probleme haben, kommentieren Sie diese Steps aus
    # und lassen Sie sie Server-side laufen (siehe unten)
    - name: Run Django migrations
      run: |
        echo "ğŸ“¦ Django Migrationen starten..."
        python manage.py migrate
      continue-on-error: true  # Falls DB von GitHub aus nicht erreichbar

    - name: Collect static files
      run: |
        echo "ğŸ“ Collecting static files..."
        python manage.py collectstatic --noinput

    - name: Login to Azure
      uses: azure/login@v2  # v1 -> v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Zip application for deployment
      run: |
        echo "ğŸ“¦ Erstelle Deployment-Package..."
        # Wir zippen alles auÃŸer .git, tests, Cache, etc.
        zip -r app.zip . -x "*.git*" "tests/*" "*__pycache__*" "*.pyc" ".env"

    - name: Deploy to Azure Web App
      run: |
        echo "ğŸš€ Deploying zu: ${{ env.APP_NAME }}"
        az webapp deploy \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --src-path app.zip \
          --type zip \
          --async false  # Wartet auf Completion, damit wir Status sehen

    - name: Restart Web App (sicherheitshalber)
      run: |
        echo "ğŸ”„ Starte App neu..."
        az webapp restart \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }}

    - name: Deployment abgeschlossen
      run: |
        echo "âœ… Deployment erfolgreich!"
        echo "ğŸŒ Ihre App lÃ¤uft unter: https://${{ env.APP_NAME }}.azurewebsi
