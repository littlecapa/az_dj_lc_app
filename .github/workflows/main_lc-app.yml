name: 'Build and deploy Python app to Azure Web App: lc-app'

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DJANGO_ENV: ${{ secrets.DJANGO_ENV }}
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      APP_NAME: ${{ secrets.APP_NAME }}

    steps:
    - name: Print simple Python message
      run: |
        python -c "print('Hallo Roger ðŸ‘‹')"
        python -c "import os; print(os.environ.get('DB_NAME')=='lc_db')"
        python -c "import os; print(os.environ.get('DB_USER')=='lc_db_admin@lcsqlserver')"
        python -c "import os; print(os.environ.get('DB_HOST')=='lcsqlserver.database.windows.net')"
        python -c "import os; print(os.environ.get('DB_PORT')=='1433')"
        python -c "import os; print(os.environ.get('RESOURCE_GROUP')=='RG_LC')"
        python -c "import os; print(os.environ.get('APP_NAME')=='lc-app')"

    - name: DNS Test
      run: nslookup lcsqlserver.database.windows.net

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python version
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.14'

    - name: Install ODBC Driver for SQL Server
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

    - name: Install pyodbc and dependencies for test
      run: |
        python -m pip install --upgrade pip
        pip install pyodbc
        pip install --no-cache-dir -r requirements.txt

    - name: Test pyODBC driver
      run: |
        python -c "import pyodbc; print(pyodbc.drivers())"
        
    - name: Run Django migrations
      run: python manage.py migrate

    - name: Collect static files
      working-directory: ./az_dj_lc_app
      run: python manage.py collectstatic --noinput

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Zip application
      run: zip -r app.zip . -x "*.git*" "tests/*" "__pycache__/*"

    - name: Deploy to Azure Web App
      working-directory: ./az_dj_lc_app
      run: az webapp deploy --name ${{ env.APP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --src-path app.zip --type zip